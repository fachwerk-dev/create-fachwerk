<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://unpkg.com/fachwerk/dist/style.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cousine&family=IBM+Plex+Sans:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="app"></div>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
      tailwind.config = {
        theme: {
          fontFamily: {
            sans: ["IBM Plex Sans", "sans-serif"],
            mono: ["Cousine", "monospace"],
          },
          extend: {
            colors: {
              lightblue: {
                50: "#F7FBFD",
                100: "#EFF8FA",
                200: "#E0F0F5",
                300: "#CCE7F0",
                400: "#BDDFEB",
                500: "#ADD8E6",
                600: "#67B6D1",
                700: "#338BA8",
                800: "#1F5466",
                900: "#0A1A1F",
              },
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      .prose button {
        @apply border-2 border-gray-600 px-4 py-1 rounded;
      }
      .prose button:hover {
        @apply bg-black/5;
      }
    </style>
    <script
      async
      src="https://unpkg.com/es-module-shims/dist/es-module-shims.js"
    ></script>
    <script type="importmap">
      {
        "imports": {
          "vue": "https://unpkg.com/vue/dist/vue.esm-browser.prod.js",
          "fachwerk": "https://unpkg.com/fachwerk/dist/fachwerk.mjs",
          "marked": "https://unpkg.com/marked/lib/marked.esm.js",
          "js-yaml": "https://unpkg.com/js-yaml/dist/js-yaml.mjs",
          "@slidev/parser": "https://unpkg.com/@slidev/parser/dist/index.mjs",
          "vue-demi": "https://unpkg.com/vue-demi/lib/index.mjs",
          "@vueuse/shared": "https://unpkg.com/@vueuse/shared/index.mjs",
          "@vueuse/core": "https://unpkg.com/@vueuse/core/index.mjs",
          "hashlru": "https://esm.sh/hashlru",
          "tailwind-merge": "https://unpkg.com/tailwind-merge/dist/index.mjs"
        }
      }
    </script>
    <script type="module">
      import { createApp, ref } from "vue";
      import { Fachwerk } from "fachwerk";
      import { parse as parseMarkdown } from "marked";
      import { parse as parseSlides } from "@slidev/parser";
      import { useStorage, onKeyStroke, onClickOutside } from "@vueuse/core";
      import { twMerge } from "tailwind-merge";

      export async function createFachwerk({
        setup = {},
        components = {},
        loader = null,
      }) {
        if (!loader) {
          loader = fetch("./slides.md").then((res) => res.text());
        }
        const rawSlides = await loader;
        let global = {};
        const slides = parseSlides(rawSlides).slides.map((s) => {
          if (s.frontmatter?.global) {
            global = { ...global, ...s.frontmatter.global };
          }
          s.frontmatter.global = global;
          return s;
        });

        const slidesTemplate = slides.map((s, i) => {
          const classes = twMerge(
            `
              p-4
              md:p-12
              max-w-none
              min-h-screen
              prose
              md:prose-xl
              prose-code:px-1
              prose-p:max-w-[70ch]
              prose-code:before:content-none
              prose-code:after:content-none
            `,
            s.frontmatter?.global?.class,
            s.frontmatter?.class
          );
          console.log(classes)
          return `<div
            class="${classes}"
            style="${s.frontmatter?.global?.style};${s.frontmatter?.style}"
            v-show="slide === ${i}"
          >
            ${parseMarkdown(s.content)}
          </div>`;
        });

        const template = `
      ${slidesTemplate.join("\n\n")}
      <div ref="menuRef" v-if="menu" class="fixed top-0 right-0 bottom-0 w-[80vw] md:w-[25vw] p-6 bg-white shadow">
        <div class="overflow-auto leading-8">
          <div class="cursor-pointer text-gray-700 hover:text-gray-900" v-for="slide in slides.filter(s => s.frontmatter?.title)" @click="goto(slide.frontmatter.title); menu = false">
            {{ slide.frontmatter?.title }}
          </div>
        </div>
      </div>
      <div class="text-lg md:text-2xl fixed right-3 bottom-3 flex text-md transition-opacity opacity-100 md:opacity-20 hover:md:opacity-100 bg-white md:bg-transparent rounded md:rounded-none shadow md:shadow-none">
        <button ref="menuIgnoreRef" class="px-2 outline-none" @click="menu = !menu">≡</button>
        <button class="px-3 outline-none" @click="prev">‹</button>
        <button class="px-3 outline-none" @click="next">›</button>
        </div>
      <div class="text-lg fixed right-3 bottom-3 flex text-md transition-opacity opacity-100 md:opacity-20 hover:md:opacity-100 bg-white md:bg-transparent rounded md:rounded-none shadow md:shadow-none">

      </div>
      `;

        const App = {
          components,
          setup() {
            const menuRef = ref(null);
            const menuIgnoreRef = ref(null);
            const menu = ref(false);
            const slide = useStorage("fachwerk_slide", 0);
            const next = () => {
              if (slide.value < slides.length - 1) slide.value++;
            };
            const prev = () => {
              if (slide.value > 0) slide.value--;
            };
            const goto = (title) => {
              const index = slides.findIndex(
                (s) => s.frontmatter?.title === title
              );
              if (index > -1) {
                slide.value = index;
              }
            };
            onKeyStroke("ArrowLeft", prev);
            onKeyStroke("ArrowRight", next);
            onClickOutside(
              menuRef,
              () => {
                menu.value = false;
              },
              { ignore: [menuIgnoreRef] }
            );

            return {
              slides,
              menuRef,
              menuIgnoreRef,
              menu,
              slide,
              next,
              prev,
              goto,
              ...setup,
            };
          },
          template,
        };

        const app = createApp(App);
        app.use(Fachwerk);
        app.mount("#app");
      }

      import * as config from "./slides.js";
      createFachwerk(config);
    </script>
  </body>
</html>
